# ========================================================
# ðŸ§© Multi-runtime container: Python + Node (single image)
# ========================================================
FROM node:20-bullseye-slim

# --------------------------------------------------------
# Install Python, pip and system dependencies
# --------------------------------------------------------
RUN apt-get update && apt-get install -y python3 python3-pip && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# --------------------------------------------------------
# Set working directory
# --------------------------------------------------------
WORKDIR /app

# --------------------------------------------------------
# Copy and install Python dependencies (cache this layer)
# --------------------------------------------------------
COPY requirements.txt .
RUN pip3 install --no-cache-dir -r requirements.txt

# --------------------------------------------------------
# Copy the rest of the backend
# --------------------------------------------------------
COPY . .

# --------------------------------------------------------
# Install Node dependencies for WhatsApp service (production only)
# --------------------------------------------------------
WORKDIR /app/whatsapp_service
RUN npm ci --omit=dev

# --------------------------------------------------------
# Expose both FastAPI and Node.js ports
# --------------------------------------------------------
EXPOSE 8000 3001

# --------------------------------------------------------
# Environment setup
# --------------------------------------------------------
WORKDIR /app
ENV PYTHONUNBUFFERED=1 \
    NODE_ENV=production

# --------------------------------------------------------
# Start both services concurrently
# --------------------------------------------------------
CMD ["bash", "-c", "node whatsapp_service/server.js & uvicorn main:app --host 0.0.0.0 --port 8000"]